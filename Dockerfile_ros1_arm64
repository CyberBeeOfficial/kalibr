# Dockerfile for Kalibr on ARM64 (Raspberry Pi 5)
# Build: docker build -f Dockerfile_ros1_arm64 -t kalibr:arm64 .
# Run:   docker run -it -v /path/to/bags:/data kalibr:arm64

# Official ROS image is multi-arch (supports amd64, arm64, arm/v7)
FROM ros:noetic-ros-base

# Prevent interactive prompts during install
ENV DEBIAN_FRONTEND=noninteractive

# ARM64-optimized dependencies
RUN apt-get update && apt-get install -y \
    git wget autoconf automake nano \
    python3-dev python3-pip python3-scipy python3-matplotlib \
    ipython3 python3-tk python3-igraph python3-pyx \
    libeigen3-dev libboost-all-dev libsuitesparse-dev \
    doxygen \
    libopencv-dev \
    libpoco-dev libtbb-dev libblas-dev liblapack-dev libv4l-dev \
    python3-catkin-tools python3-osrf-pycommon \
    # ARM64-specific optimizations
    libatlas-base-dev \
    libopenblas-dev \
    # Additional build tools
    build-essential cmake \
    && rm -rf /var/lib/apt/lists/*

# Use OpenBLAS for better ARM performance
ENV OPENBLAS_NUM_THREADS=4
ENV OMP_NUM_THREADS=4

# Create workspace
ENV WORKSPACE=/catkin_ws
RUN mkdir -p $WORKSPACE/src

# Initialize catkin workspace with ARM64-optimized flags
WORKDIR $WORKSPACE
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && \
    catkin init && \
    catkin config --extend /opt/ros/noetic && \
    catkin config --cmake-args \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_FLAGS='-O3 -march=armv8-a+crc+simd' \
        -DEIGEN_MAX_ALIGN_BYTES=16"

# Copy kalibr source
ADD . $WORKSPACE/src/kalibr

# Build with reduced parallelism for Pi 5 memory constraints
# -j2 prevents OOM on 4GB Pi 5, use -j4 for 8GB version
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && \
    cd $WORKSPACE && \
    catkin build -j2 --no-status"

# Setup entrypoint script
RUN echo '#!/bin/bash\n\
export KALIBR_MANUAL_FOCAL_LENGTH_INIT=1\n\
source /opt/ros/noetic/setup.bash\n\
source /catkin_ws/devel/setup.bash\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]

# Usage examples:
#
# Build on ARM64 (native on Pi 5):
#   docker build -f Dockerfile_ros1_arm64 -t kalibr:arm64 .
#
# Build via cross-compilation (from x86 machine):
#   docker buildx create --use
#   docker buildx build --platform linux/arm64 -f Dockerfile_ros1_arm64 -t kalibr:arm64 --load .
#
# Run calibration:
#   docker run -it -v $(pwd)/data:/data kalibr:arm64
#   rosrun kalibr kalibr_calibrate_imu_camera --bag /data/calib.bag --cam /data/cam.yaml --imu /data/imu.yaml --target /data/target.yaml
