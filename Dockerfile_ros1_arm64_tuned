# Dockerfile for Kalibr ARM64 with custom tuning for VINS-Mono
# Based on pre-built ARM64 image, adds optimized calibration parameters

FROM prehensile/kalibr:arm64

# Copy the tuned calibration scripts and modules
COPY aslam_offline_calibration/kalibr/python/kalibr_calibrate_imu_camera \
     /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_calibrate_imu_camera

COPY aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccCalibrator.py \
     /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccCalibrator.py

COPY aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccSensors.py \
     /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccSensors.py

# Find and overwrite ALL installed copies so the updated code is guaranteed to run
RUN set -e && \
    # Find every installed copy of the main script
    find /catkin_ws/devel -name "kalibr_calibrate_imu_camera" -exec cp -v \
        /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_calibrate_imu_camera {} \; && \
    # Find every installed copy of IccCalibrator.py
    find /catkin_ws/devel -name "IccCalibrator.py" -path "*/kalibr_imu_camera_calibration/*" -exec cp -v \
        /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccCalibrator.py {} \; && \
    # Find every installed copy of IccSensors.py
    find /catkin_ws/devel -name "IccSensors.py" -path "*/kalibr_imu_camera_calibration/*" -exec cp -v \
        /catkin_ws/src/kalibr/aslam_offline_calibration/kalibr/python/kalibr_imu_camera_calibration/IccSensors.py {} \; && \
    # Verify at least one copy was updated
    echo "=== Verifying updated files ===" && \
    grep -l "is_arm" $(find /catkin_ws/devel -name "kalibr_calibrate_imu_camera" | head -1) && \
    echo "SUCCESS: Updated code is in place"

# Create python symlink (noetic uses python3)
RUN ln -sf /usr/bin/python3 /usr/bin/python

# Setup proper entrypoint
RUN echo '#!/bin/bash\n\
export KALIBR_MANUAL_FOCAL_LENGTH_INIT=1\n\
source /opt/ros/noetic/setup.bash\n\
source /catkin_ws/devel/setup.bash\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
